<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verified Ticket | LAKSHYA 2K26</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-green: #0aff68;
            --neon-red: #ff0a44;
            --neon-gold: #ffd700;
            
            --bg-deep: #050508;
            --glass-bg: rgba(20, 20, 35, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            --text-main: #ffffff;
            --text-dim: #8b9bb4;
        }
        
        * { box-sizing: border-box; }

        body { 
            background-color: var(--bg-deep);
            color: var(--text-main); 
            font-family: 'Rajdhani', sans-serif; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(0, 243, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, rgba(188, 19, 254, 0.15) 0%, transparent 50%);
        }

        /* --- BACKGROUND FX --- */
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            z-index: -1;
            pointer-events: none;
        }

        .particles {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            z-index: -2;
            animation: particleDrift 60s linear infinite;
        }
        @keyframes particleDrift { from { background-position: 0 0; } to { background-position: 0 600px; } }

        /* --- TICKET CONTAINER --- */
        .pass-container {
            width: 100%;
            max-width: 900px;
            position: relative;
            z-index: 10;
            margin-bottom: 40px;
            perspective: 1500px;
        }

        /* --- THE TICKET --- */
        .ticket-wrapper {
            display: flex;
            position: relative;
            border-radius: 20px;
            /* Neon Glow Shadow */
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
            transition: transform 0.3s ease;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotateX(0deg); }
            50% { transform: translateY(-15px) rotateX(2deg); }
        }

        /* The glowing border container */
        .ticket-border-glow {
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, var(--neon-purple), var(--neon-blue), var(--neon-purple));
            border-radius: 22px;
            z-index: -1;
            opacity: 0.6;
            filter: blur(10px);
            animation: borderPulse 4s linear infinite;
        }
        @keyframes borderPulse { 0% { opacity: 0.4; } 50% { opacity: 0.7; } 100% { opacity: 0.4; } }

        .ticket-content {
            display: flex;
            width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        /* --- SCANNER BEAM --- */
        .scanner-beam {
            position: absolute;
            top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: skewX(-20deg);
            animation: scan 3s infinite cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 20;
        }
        @keyframes scan { 0% { left: -100%; } 100% { left: 200%; } }

        /* --- LEFT: MAIN INFO --- */
        .main-section {
            flex: 1;
            padding: 40px;
            position: relative;
            border-right: 2px dashed rgba(255, 255, 255, 0.15);
        }

        /* Circular Punch Holes */
        .punch-hole-top, .punch-hole-bottom {
            position: absolute;
            right: -12px; 
            width: 24px; height: 24px;
            background-color: var(--bg-deep);
            border-radius: 50%;
            z-index: 5;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }
        .punch-hole-top { top: -12px; }
        .punch-hole-bottom { bottom: -12px; }

        /* Branding Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
        }
        
        .logos { display: flex; gap: 20px; align-items: center; }
        .logo-img { height: 45px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); transition: transform 0.3s; }
        .logo-img:hover { transform: scale(1.05); }

        .pass-type {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 900;
            color: var(--neon-blue);
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 8px 16px;
            border: 1px solid var(--neon-blue);
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
            text-shadow: 0 0 5px var(--neon-blue);
        }

        /* Event Title */
        .event-title {
            font-family: 'Space Mono', monospace;
            color: var(--neon-purple);
            font-size: 0.9rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        /* User Name (Hero) */
        .attendee-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0 0 30px 0;
            text-transform: uppercase;
            line-height: 1.1;
            background: linear-gradient(180deg, #fff 0%, #a2a2a2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));
        }

        /* Info Grid */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }
        
        .detail-item label {
            display: block;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .detail-item span {
            font-size: 1.25rem;
            font-weight: 600;
            color: #fff;
            letter-spacing: 0.5px;
        }
        
        .mono-val { font-family: 'Space Mono', monospace; font-size: 1rem !important; }
        .team-val { font-size: 0.95rem !important; color: var(--text-dim) !important; line-height: 1.4; }

        /* --- RIGHT: STUB & VERIFICATION --- */
        .stub-section {
            width: 300px;
            background: rgba(0,0,0,0.2);
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
        }

        /* Verification Circle */
        .verify-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid transparent; /* controlled by state class */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.3);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .verify-circle::after {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            border: 2px dashed rgba(255,255,255,0.1);
            animation: spin 10s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Status Text */
        .status-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            text-shadow: 0 0 10px currentColor;
        }

        .status-sub {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-dim);
            opacity: 0.8;
            margin-bottom: 20px;
        }

        /* Xeta Badge */
        .xeta-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.05);
            padding: 8px 16px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-top: auto;
        }
        .xeta-badge i { color: var(--neon-blue); font-size: 0.9rem; }
        .xeta-badge span {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 0.8rem;
            color: #fff;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* --- STATES --- */
        .state-success .verify-circle { 
            border-color: var(--neon-green); 
            color: var(--neon-green); 
            box-shadow: 0 0 30px rgba(10, 255, 104, 0.3), inset 0 0 20px rgba(10, 255, 104, 0.2);
        }
        .state-success .status-text { color: var(--neon-green); }
        .state-success .pass-type { border-color: var(--neon-green); color: var(--neon-green); box-shadow: 0 0 10px rgba(10, 255, 104, 0.2); }

        .state-error .verify-circle { 
            border-color: var(--neon-red); 
            color: var(--neon-red);
            box-shadow: 0 0 30px rgba(255, 10, 68, 0.3), inset 0 0 20px rgba(255, 10, 68, 0.2);
        }
        .state-error .status-text { color: var(--neon-red); }
        .state-error .pass-type { border-color: var(--neon-red); color: var(--neon-red); box-shadow: 0 0 10px rgba(255, 10, 68, 0.2); }

        /* --- FOOTER --- */
        .footer {
            text-align: center;
            margin-top: 50px;
            font-family: 'Rajdhani', sans-serif;
            opacity: 0;
            animation: fadeIn 1s ease-out 1s forwards;
        }
        
        .footer-line {
            font-size: 1rem;
            color: var(--text-dim);
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .footer-line span {
            color: var(--neon-blue);
            font-weight: 700;
            text-transform: uppercase;
            position: relative;
        }
        
        .footer-sub {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 850px) {
            .ticket-content { flex-direction: column; }
            .main-section { border-right: none; border-bottom: 2px dashed rgba(255,255,255,0.1); }
            .punch-hole-top, .punch-hole-bottom { display: none; }
            .stub-section { width: 100%; padding: 40px 20px; }
            .attendee-name { font-size: 2rem; }
        }

        @keyframes fadeIn { to { opacity: 1; } }
        
        /* Loader */
        .loader-container { text-align: center; margin-top: 50px; }
        .cyber-spinner {
            width: 50px; height: 50px;
            border: 3px solid transparent;
            border-top-color: var(--neon-blue);
            border-right-color: var(--neon-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
            box-shadow: 0 0 15px var(--neon-blue);
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="particles"></div>

    <div id="verifyContainer" class="pass-container">
        <div class="loader-container">
            <div class="cyber-spinner"></div>
            <p style="font-family:'Orbitron'; letter-spacing:3px; font-size:0.9rem; color:var(--text-dim);">ESTABLISHING SECURE CONNECTION...</p>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-line">
            Designed & Developed By <span>Xeta</span>
        </div>
        <div class="footer-sub">A StartUp from AI&DS Lbrce</div>
    </footer>

    <script>
        const LOGO_EVENT = "https://res.cloudinary.com/dpz44zf0z/image/upload/v1764605760/logo_oeso2m.png";
        const LOGO_CLG = "https://res.cloudinary.com/dpz44zf0z/image/upload/v1764610592/1000150316_94d436c3b0efe15eb7fb1d332f32709f-10_6_2025_7_05_27_AM_wt8kgm.png";

        async function verify() {
            const params = new URLSearchParams(window.location.search);
            const regId = params.get('id');
            const container = document.getElementById('verifyContainer');

            // Artificial delay for the "Cyber" loading effect
            await new Promise(r => setTimeout(r, 1200));

            if (!regId) {
                renderState("error", "ACCESS DENIED", "MISSING_IDENTITY_TOKEN", {});
                return;
            }

            try {
                const res = await fetch(`/api/public/receipt-details/${regId}`);
                if (!res.ok) throw new Error("Not Found");
                
                const data = await res.json();
                const { reg, event, user, systemInfo } = data;

                if (reg.paymentStatus !== 'COMPLETED') {
                    renderState("error", "PENDING", "PAYMENT NOT VERIFIED", { reg, event, user, systemInfo });
                    return;
                }

                const kitKeywords = ['major', 'mba', 'management', 'cultural', 'music', 'dance', 'singing', 'drama', 'art', 'fashion', 'literary'];
                let hasKit = event.kit || kitKeywords.some(k => (event.type||'').toLowerCase().includes(k));
                if (parseFloat(reg.amountPaid) < (parseFloat(event.fee) - 1)) hasKit = false;

                renderState("success", "VERIFIED", "ACCESS GRANTED", { reg, event, user, hasKit, systemInfo });

            } catch (err) {
                console.error(err);
                // Fallback for visual testing
                renderState("error", "SYSTEM ERROR", "DATABASE_UNREACHABLE", {});
            }
        }

        function renderState(type, statusText, subMsg, data) {
            const container = document.getElementById('verifyContainer');
            const { reg, event, user, hasKit, systemInfo } = data;
            
            // --- DATA LOGIC ---
            const isTeam = reg?.teamName ? true : false;
            const mainTitle = isTeam ? reg.teamName : (user?.fullName || "UNKNOWN ENTITY");
            const leadName = user?.fullName || "N/A";
            const eventTitle = event?.title || "UNSPECIFIED PROTOCOL";
            const dept = reg?.deptName || "N/A";
            const roll = user?.rollNo || "N/A";
            
            // System ID Logic
            let displayId = reg?.registrationId ? reg.registrationId.substring(0,8).toUpperCase() : "NO_ID";
            if (systemInfo && systemInfo.serialStart > 0) {
                const paddedSerial = systemInfo.serialStart.toString().padStart(3, '0');
                displayId = `${systemInfo.code}00${paddedSerial}`;
            }

            // Styling State
            const stateClass = type === 'success' ? 'state-success' : 'state-error';
            const icon = type === 'success' ? 'fa-check' : 'fa-xmark';
            const passLabel = type === 'success' ? (hasKit ? 'VIP ACCESS + KIT' : 'STANDARD ACCESS') : 'INVALID TOKEN';

            // Conditional HTML
            let teamHtml = '';
            if(reg?.teamMembers && reg.teamMembers.length > 0) {
                const names = reg.teamMembers.map(m => m.name).join(' // ');
                teamHtml = `
                    <div class="detail-item" style="grid-column: 1 / -1; margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 15px;">
                        <label>Unit Members [${reg.teamMembers.length}]</label>
                        <span class="team-val">${names}</span>
                    </div>`;
            }

            let leadHtml = '';
            if (isTeam) {
                leadHtml = `
                    <div class="detail-item">
                        <label>Squad Leader</label>
                        <span>${leadName}</span>
                    </div>
                `;
            }

            // --- RENDER ---
            container.innerHTML = `
                <div class="ticket-wrapper">
                    <div class="ticket-border-glow"></div>
                    <div class="ticket-content ${stateClass}">
                        <div class="scanner-beam"></div>
                        <div class="punch-hole-top"></div>
                        <div class="punch-hole-bottom"></div>

                        <!-- MAIN SECTION -->
                        <div class="main-section">
                            <div class="header">
                                <div class="logos">
                                    <img src="${LOGO_CLG}" class="logo-img" alt="LBRCE">
                                    <img src="${LOGO_EVENT}" class="logo-img" alt="LAKSHYA">
                                </div>
                                <div class="pass-type">${passLabel}</div>
                            </div>

                            <div class="event-title">${eventTitle}</div>
                            <h1 class="attendee-name">${mainTitle}</h1>

                            <div class="details-grid">
                                ${leadHtml}
                                <div class="detail-item">
                                    <label>Sector / Dept</label>
                                    <span>${dept}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Identity Code</label>
                                    <span class="mono-val">${roll}</span>
                                </div>
                                <div class="detail-item">
                                    <label>System Ref. ID</label>
                                    <span class="mono-val" style="color:var(--neon-blue);">${displayId}</span>
                                </div>
                                ${teamHtml}
                            </div>
                        </div>

                        <!-- STUB SECTION -->
                        <div class="stub-section">
                            <div class="verify-circle">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            
                            <div class="status-text">${statusText}</div>
                            <div class="status-sub">${subMsg}</div>

                            <div class="xeta-badge">
                                <i class="fa-solid fa-shield-halved"></i>
                                <span>Verified by Xeta Server</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        verify();
    </script>
</body>
</html>
