<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupon Analytics | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #00d2ff;
            --secondary-color: #ff00cc;
            --bg-color: #050510;
            --card-bg: #151520;
            --border: rgba(255,255,255,0.1);
        }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg-color); color: white; margin: 0; padding: 20px; }

        .dashboard-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-header h2 { font-family: 'Montserrat', sans-serif; color: var(--primary-color); margin: 0; }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 12px;
            text-align: center;
        }
        .stat-num { font-size: 2rem; font-weight: bold; color: white; }
        .stat-label { color: #888; font-size: 0.9rem; text-transform: uppercase; }

        .charts-container {
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;
        }
        .chart-box {
            background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 12px; height: 350px;
        }

        .stalls-table {
            width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden;
        }
        .stalls-table th, .stalls-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); }
        .stalls-table th { background: rgba(0, 210, 255, 0.1); color: var(--primary-color); }
        .amount-highlight { color: #00ff88; font-weight: bold; }
        
        .stall-link { color: #00d2ff; cursor: pointer; text-decoration: underline; font-weight: bold; }
        .stall-link:hover { color: #fff; }

        /* MODAL CSS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #1a1a25; width: 90%; max-width: 600px; max-height: 80vh;
            border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column;
        }
        .modal-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 0; overflow-y: auto; flex-grow: 1; }
        .modal-actions { display: flex; gap: 15px; align-items: center; }
        .close-btn, .print-btn-modal { color: #fff; cursor: pointer; font-size: 1.2rem; }
        .print-btn-modal:hover { color: #00d2ff; }

        .hist-item { padding: 15px 20px; border-bottom: 1px solid #333; }
        .hist-item:last-child { border-bottom: none; }
        .hist-top { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .h-name { font-weight: bold; color: #fff; }
        .h-time { color: #888; font-size: 0.8rem; }
        .h-email { color: #aaa; font-size: 0.9rem; }
        .h-code { color: #00d2ff; font-family: monospace; font-size: 0.8rem; }

        @media (max-width: 768px) { .charts-container { grid-template-columns: 1fr; } }

        /* PRINT STYLES - Hides dashboard, shows only modal content cleanly */
        @media print {
            body > * { display: none !important; }
            
            #historyModal {
                display: block !important;
                position: absolute !important;
                top: 0 !important; left: 0 !important;
                width: 100% !important; height: auto !important;
                background: white !important;
                color: black !important;
                z-index: 9999 !important;
            }
            .modal-content {
                width: 100% !important; max-width: 100% !important; height: auto !important;
                border: none !important; box-shadow: none !important;
                background: white !important;
            }
            .modal-header { border-bottom: 2px solid #000 !important; color: black !important; }
            .modal-header h3 { color: black !important; }
            .modal-actions { display: none !important; }

            .modal-body { overflow: visible !important; height: auto !important; }
            
            .hist-item {
                border-bottom: 1px solid #ccc !important;
                color: black !important;
                page-break-inside: avoid;
            }
            .h-name { color: black !important; }
            .h-email { color: #333 !important; }
            .h-time { color: #555 !important; }
            .h-code { color: #000 !important; font-weight: bold; }
        }

    </style>
</head>
<body>

    <div class="dashboard-header">
        <div>
            <h2>Coupon Analytics</h2>
            <p style="color:#888; margin-top:5px;">Real-time usage and settlement tracking.</p>
        </div>
        <!-- Global Dashboard Print -->
        <button onclick="window.print()" style="padding:10px 20px; background:#333; color:white; border:none; border-radius:5px; cursor:pointer;">
            <i class="fa-solid fa-print"></i> Report
        </button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-num" id="statIssued" style="color: #00d2ff;">0</div>
            <div class="stat-label">Total Issued</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="statRedeemed" style="color: #00ff88;">0</div>
            <div class="stat-label">Total Redeemed</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="statPending" style="color: #ffcc00;">0</div>
            <div class="stat-label">Pending Usage</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="statValue">₹0</div>
            <div class="stat-label">Est. Payout Value</div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box">
            <h4 style="margin-bottom:15px;">Hourly Redemption Rate</h4>
            <canvas id="timeChart"></canvas>
        </div>
        <div class="chart-box">
            <h4 style="margin-bottom:15px;">Department Usage</h4>
            <canvas id="deptChart"></canvas>
        </div>
    </div>

    <h3 style="margin-bottom:15px; color:#fff;">Stall Settlement</h3>
    <table class="stalls-table">
        <thead>
            <tr>
                <th>Stall Name</th>
                <th>Coupons Scanned</th>
                <th>Last Active</th>
                <th>Total Payout (₹50/unit)</th>
            </tr>
        </thead>
        <tbody id="stallTableBody">
            <tr><td colspan="4" style="text-align:center; color:#666;">Loading Data...</td></tr>
        </tbody>
    </table>

    <!-- History Modal -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color: #fff;" id="modalTitle">Stall History</h3>
                <div class="modal-actions">
                    <div class="print-btn-modal" onclick="window.print()" title="Print History"><i class="fa-solid fa-print"></i></div>
                    <span class="close-btn" onclick="closeModal()">&times;</span>
                </div>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Items -->
            </div>
        </div>
    </div>

    <script>
        async function loadStats() {
            try {
                const res = await fetch('/api/admin/coupon-analytics');
                const data = await res.json();

                // 1. Update Top Stats
                document.getElementById('statIssued').innerText = data.totalIssued;
                document.getElementById('statRedeemed').innerText = data.totalRedeemed;
                document.getElementById('statPending').innerText = data.totalIssued - data.totalRedeemed;
                document.getElementById('statValue').innerText = '₹' + (data.totalRedeemed * 50).toLocaleString();

                // 2. Render Charts
                renderCharts(data);

                // 3. Render Table (WITH CLICK HANDLER)
                const tbody = document.getElementById('stallTableBody');
                tbody.innerHTML = data.stalls.map(s => `
                    <tr>
                        <td>
                            <span class="stall-link" onclick="viewStallHistory('${s.id}')">
                                ${s.name}
                            </span>
                            <br><small style="color:#666">${s.id}</small>
                        </td>
                        <td>${s.count}</td>
                        <td>${new Date(s.lastActive).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                        <td class="amount-highlight">₹${(s.count * 50).toLocaleString()}</td>
                    </tr>
                `).join('');

            } catch (e) {
                console.error(e);
            }
        }

        async function viewStallHistory(stallId) {
            const modal = document.getElementById('historyModal');
            const body = document.getElementById('modalBody');
            const title = document.getElementById('modalTitle');
            
            title.innerText = `History: ${stallId}`;
            modal.style.display = 'flex';
            body.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Loading...</div>';

            try {
                const res = await fetch(`/api/admin/stall-history?stallId=${encodeURIComponent(stallId)}`);
                const items = await res.json();

                if(items.length === 0) {
                    body.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">No history found.</div>';
                    return;
                }

                body.innerHTML = items.map(i => {
                    const date = new Date(i.redeemedAt);
                    return `
                    <div class="hist-item">
                        <div class="hist-top">
                            <span class="h-name">${i.holderName || 'Unknown Student'}</span>
                            <span class="h-time">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</span>
                        </div>
                        <div class="h-email">${i.holderEmail}</div>
                        <div class="h-code">Coupon: ${i.code}</div>
                    </div>`;
                }).join('');

            } catch(e) {
                body.innerHTML = '<div style="padding:20px; text-align:center; color:red;">Failed to load.</div>';
            }
        }

        function closeModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function renderCharts(data) {
            // Check if chart instance exists and destroy if needed (prevents canvas reuse error)
            // For simplicity in this static file, we assume fresh load
            
            new Chart(document.getElementById('timeChart'), {
                type: 'line',
                data: {
                    labels: data.hourlyStats.labels,
                    datasets: [{
                        label: 'Coupons Redeemed',
                        data: data.hourlyStats.values,
                        borderColor: '#00d2ff',
                        backgroundColor: 'rgba(0, 210, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            new Chart(document.getElementById('deptChart'), {
                type: 'doughnut',
                data: {
                    labels: data.deptStats.map(d => d.dept),
                    datasets: [{
                        data: data.deptStats.map(d => d.count),
                        backgroundColor: ['#ff00cc', '#00d2ff', '#ffcc00', '#00ff88', '#888']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        window.onload = loadStats;
    </script>
</body>
</html>
